You are a Replit AI agent working on Alpmera. Apply changes directly. The user does NOT manually edit code.

BUGFIX BATCH: Campaign Detail auth state is stale (still shows “Sign in to join” after login)

GOAL:
On the Campaign Detail page, when a user is signed in, the right-side “Participation terms” card must switch from:
- “Sign in to join”
to:
- “Join campaign”
and show the member-only message accordingly, WITHOUT requiring a manual refresh.

GUARDRAILS:
- Do NOT change auth backend behavior (email code, cookies).
- Do NOT change escrow/ledger/idempotency.
- Minimal changes; do NOT refactor routing broadly.
- Use existing /api/me endpoint as the source of truth.
- No store language.

ROOT CAUSE TO FIX:
Campaign Detail page is likely using:
- a cached “isAuthenticated” boolean that doesn’t update, OR
- it checks auth only once on initial mount and never revalidates, OR
- it uses localStorage flags instead of /api/me, OR
- the header “Account” state updates but the page component does not re-render.

IMPLEMENT THE MOST RELIABLE MINIMAL FIX (choose the smallest path that fits current code):

STEP 1 — Find how auth is tracked
- Search the codebase for:
  - `/api/me`
  - `useAuth`
  - `AuthContext`
  - `isAuthenticated`
  - `me`
- Identify the canonical way the app knows the current user.
- Ensure Campaign Detail uses the same canonical source, not a one-off state.

STEP 2 — Ensure Campaign Detail fetches /api/me and updates on auth change
Implement ONE of these patterns (prefer A, then B):

A) If there is an AuthContext / useAuth():
- Make Campaign Detail read `user` (or `isLoggedIn`) from the shared auth context.
- Ensure the sign-in success flow updates the context (most likely already does since header changes to “Account”).
- If Campaign Detail still doesn’t update, it is not subscribing to the context; fix it to do so.

B) If there is NO shared auth context or it’s unreliable:
- In Campaign Detail component:
  - Add state: `me`, `meLoading`
  - On mount: call GET /api/me and set `me`
  - Also listen for route/location changes and window focus:
    - on `visibilitychange` (document becomes visible) -> refetch /api/me
    - on window `focus` -> refetch /api/me
This is cheap and robust.

Additionally, add a lightweight global event to signal auth change:
- In the sign-in success handler (where login completes), dispatch:
  window.dispatchEvent(new Event("alpmera-auth-changed"))
- In Campaign Detail, add an event listener:
  window.addEventListener("alpmera-auth-changed", refetchMe)
This ensures immediate update.

STEP 3 — Fix the CTA condition
Replace any stale checks with:
- `const isSignedIn = !!me?.email || !!me?.id` (depending on /api/me response)
Then render:
- If NOT signed in:
  - show “Sign in to join” button
- If signed in:
  - show “Join campaign” button
  - adjust helper copy (no mention of signing in)

STEP 4 — Verify sign-in route + returnTo already works
- Do not change routing unless necessary.
- Keep return-to behavior as implemented.

ACCEPTANCE TESTS:
1) Open campaign detail in a private window (not signed in) -> see “Sign in to join”.
2) Click “Sign in to join”, complete login -> redirected back to same campaign detail -> MUST now show “Join campaign”.
3) If user logs in from header “Sign in” while staying on campaign detail -> the card MUST update to “Join campaign” within 1 second (no refresh).
4) Header already shows “Account” after login; campaign detail must match.

DELIVERABLE:
- Campaign detail uses canonical auth source or refetches /api/me on auth change (focus/visibility + auth event).
- CTA updates correctly post-login.
- Brief list of files changed and what you changed (no large code dump).
